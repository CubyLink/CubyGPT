<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/static/favicon.png" crossorigin="use-credentials" />
    <link rel="icon" type="image/png" href="/static/favicon-96x96.png" sizes="96x96" crossorigin="use-credentials" />
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" crossorigin="use-credentials" />
    <link rel="shortcut icon" href="/static/favicon.ico" crossorigin="use-credentials" />
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" crossorigin="use-credentials" />
    <meta name="apple-mobile-web-app-title" content="Open WebUI" />
    <link rel="manifest" href="/manifest.json" crossorigin="use-credentials" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#171717" />
    <meta name="robots" content="noindex,nofollow" />
    <meta name="description" content="Open WebUI" />
    <link rel="search" type="application/opensearchdescription+xml" title="Open WebUI" href="/opensearch.xml" crossorigin="use-credentials" />
    <script src="/static/loader.js" defer crossorigin="use-credentials"></script>
    <link rel="stylesheet" href="/static/custom.css" crossorigin="use-credentials" />

    <script>
      function resizeIframe(obj) {
        obj.style.height = obj.contentWindow.document.documentElement.scrollHeight + 'px';
      }
    </script>

    <script>
      // On page load or when changing themes, best to add inline in `head` to avoid FOUC
      (() => {
        const metaThemeColorTag = document.querySelector('meta[name="theme-color"]');
        const prefersDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (!localStorage?.theme) {
          localStorage.theme = 'system';
        }

        if (localStorage.theme === 'system') {
          document.documentElement.classList.add(prefersDarkTheme ? 'dark' : 'light');
          metaThemeColorTag.setAttribute('content', prefersDarkTheme ? '#171717' : '#ffffff');
        } else if (localStorage.theme === 'oled-dark') {
          document.documentElement.style.setProperty('--color-gray-800', '#101010');
          document.documentElement.style.setProperty('--color-gray-850', '#050505');
          document.documentElement.style.setProperty('--color-gray-900', '#000000');
          document.documentElement.style.setProperty('--color-gray-950', '#000000');
          document.documentElement.classList.add('dark');
          metaThemeColorTag.setAttribute('content', '#000000');
        } else if (localStorage.theme === 'light') {
          document.documentElement.classList.add('light');
          metaThemeColorTag.setAttribute('content', '#ffffff');
        } else if (localStorage.theme === 'her') {
          document.documentElement.classList.add('her');
          metaThemeColorTag.setAttribute('content', '#983724');
        } else {
          document.documentElement.classList.add('dark');
          metaThemeColorTag.setAttribute('content', '#171717');
        }

        window.matchMedia('(prefers-color-scheme: dark)').addListener((e) => {
          if (localStorage.theme === 'system') {
            if (e.matches) {
              document.documentElement.classList.add('dark');
              document.documentElement.classList.remove('light');
              metaThemeColorTag.setAttribute('content', '#171717');
            } else {
              document.documentElement.classList.add('light');
              document.documentElement.classList.remove('dark');
              metaThemeColorTag.setAttribute('content', '#ffffff');
            }
          }
        });
        const isDarkMode = document.documentElement.classList.contains('dark');

        const logo = document.createElement('img');
        logo.id = 'logo';
        logo.style = 'position: absolute; width: auto; height: 6rem; top: 44%; left: 50%; transform: translateX(-50%); display:block;';
        logo.src = isDarkMode ? '/static/splash-dark.png' : '/static/splash.png';

        document.addEventListener('DOMContentLoaded', function () {
          const splash = document.getElementById('splash-screen');
          if (document.documentElement.classList.contains('her')) {
            return;
          }

          if (splash) splash.prepend(logo);
        });
      })();
    </script>

    <title>CubyGPT</title>

    %sveltekit.head%

    <!-- ====================
         Banner / layout CSS
         ==================== -->
    <style id="company-footer-style">
      :root{
        --banner-height: 72px;
        /* noch hellere Farben für bessere Lesbarkeit */
        --banner-bg-1: #4aa1a8; /* heller */
        --banner-bg-2: #2fa7af; /* heller */
        --banner-color: #ffffff;
        --banner-max-width: 1400px;
      }

      /* Grundlayout: html/body full height, allow scrolling in #app-root */
      html, body {
        height: 100%;
        margin: 0;
        overscroll-behavior-y: auto;
        -webkit-font-smoothing:antialiased;
      }

      /* APP root: der scrollbare Bereich */
      #app-root {
        position: relative;
        min-height: 100vh;
        box-sizing: border-box;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        /* ausreichend padding, damit letzter Content sichtbar bleibt */
        padding-bottom: calc(var(--banner-height) + 20px);
      }

      /* Footer banner (fixed bottom). Banner ist etwas heller */
      #company-bottom-banner {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: var(--banner-height);
        width: 100%;
        background: linear-gradient(180deg, var(--banner-bg-1), var(--banner-bg-2));
        color: var(--banner-color);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
        -webkit-font-smoothing: antialiased;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        z-index: 200; /* Banner unter interaktiven UI, but script will bump UI to >200 */
        display: flex;
        align-items: center;
        pointer-events: auto;
      }

      #company-bottom-banner .inner {
        width: 100%;
        max-width: var(--banner-max-width);
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        box-sizing: border-box;
      }

      #company-bottom-banner .logo { flex: 0 0 auto; display: flex; align-items:center; }
      #company-bottom-banner .logo img { height: 48px; width: auto; display:block; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2)); }

      #company-bottom-banner .title {
        flex: 1 1 auto;
        text-align: center;
        font-weight: 600;
        font-size: 20px;
        line-height: 1;
        user-select: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #company-bottom-banner .links {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }
      #company-bottom-banner .links a {
        color: var(--banner-color);
        text-decoration: none;
        padding: 6px 8px;
      }
      #company-bottom-banner .links a:hover,
      #company-bottom-banner .links a:focus { text-decoration: underline; outline: none; }

      /* responsive */
      @media (max-width: 900px) {
        #company-bottom-banner .title { font-size: 16px; }
        #company-bottom-banner .logo img { height: 40px; }
        #company-bottom-banner .inner { padding: 10px 12px; }
      }

      @media (max-width: 520px) {
        #company-bottom-banner .inner { flex-wrap: wrap; gap: 8px; }
        #company-bottom-banner .title { order: 2; width: 100%; text-align:left; }
        #company-bottom-banner .links { order: 3; }
        #company-bottom-banner .logo  { order: 1; }
      }
    </style>

    <!-- ===== existing splash / global styles (kept) ===== -->
    <style type="text/css" nonce="">
      /* simplified copy of your splash styles - kept for compatibility */
      #splash-screen { background: #fff; }
      html.dark #splash-screen { background: #000; }
      html.her #splash-screen { background: #983724; }
      #logo-her { display: none; }
      #progress-background, #progress-bar { display: none; }
      html.her #logo { display:none; }
      html.her #logo-her { display:block; filter: invert(1); }
      html.her #progress-background { display:block; }
      html.her #progress-bar { display:block; }
      @keyframes pulse { 50%{ opacity:0.65 } }
      .animate-pulse-fast { animation: pulse 1.5s cubic-bezier(0.4,0,0.6,1) infinite; }
    </style>
  </head>

  <body data-sveltekit-preload-data="hover">
    <!-- SCROLLABLE ROOT (wichtig: Content scrollt hier, nicht das <body>) -->
    <div id="app-root">
      %sveltekit.body%
    </div>

    <!-- splash-screen kept -->
    <div id="splash-screen" style="position: fixed; z-index: 100; top: 0; left: 0; width: 100%; height: 100%">
      <style type="text/css" nonce="">
        html { overflow-y: scroll !important; }
      </style>

      <div style="position:absolute; top:33%; left:50%; width:24rem; transform:translateX(-50%); display:flex; flex-direction:column; align-items:center;">
        <img id="logo-her" style="width:auto; height:13rem" src="/static/splash.png" class="animate-pulse-fast" />
        <div style="position:relative; width:24rem; margin-top:0.5rem">
          <div id="progress-background" style="position:absolute; width:100%; height:0.75rem; border-radius:9999px; background-color:#fafafa9a;"></div>
          <div id="progress-bar" style="position:absolute; width:0%; height:0.75rem; border-radius:9999px; background-color:#fff;" class="bg-white"></div>
        </div>
      </div>
    </div>

    <!-- ===== Company Footer Banner (fixed bottom) ===== -->
    <footer id="company-bottom-banner" role="contentinfo" aria-label="Firmenbanner">
      <div class="inner" role="region" aria-label="Firmeninformationen">
        <div class="logo" aria-hidden="false">
          <img src="/static/mylogo.png" alt="Firmenlogo" />
        </div>

        <div class="title">CubyGPT - Your personal AI assistant</div>

        <nav class="links" aria-label="Rechtliche Links">
          <a href="https://cubylink.com/datenschutz" target="_blank" rel="noopener noreferrer">Datenschutz</a>
          <span aria-hidden="true">·</span>
          <a href="https://cubylink.com/impressum" target="_blank" rel="noopener noreferrer">Impressum</a>
        </nav>
      </div>
    </footer>

    <!-- =============================
         JS: adjust bottom-anchored UI & clamp scrolling
         ============================= -->
    <script>
      (function () {
        const ADJUST_CLASS = 'banner-bottom-adjusted';
        const BANNER_ID = 'company-bottom-banner';
        const OFFSET = 'calc(var(--banner-height,72px) + 8px)';
        const SAFETY_MAX = 2000;

        function getBannerZ() {
          const banner = document.getElementById(BANNER_ID);
          if (!banner) return 200;
          const cs = getComputedStyle(banner);
          const z = parseInt(cs.zIndex);
          return Number.isFinite(z) ? z : 200;
        }

        function isVisible(el) {
          try {
            if (!el) return false;
            const cs = getComputedStyle(el);
            if (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0') return false;
            const rect = el.getBoundingClientRect();
            if (rect.width === 0 && rect.height === 0) return false;
            return true;
          } catch (e) { return false; }
        }

        function shouldAdjust(el) {
          if (!el || el.id === BANNER_ID || (el.closest && el.closest('#' + BANNER_ID))) return false;
          if (el.classList && el.classList.contains(ADJUST_CLASS)) return false;
          if (!isVisible(el)) return false;
          const cs = getComputedStyle(el);
          if (!(cs.position === 'fixed' || cs.position === 'absolute')) return false;
          if (!(cs.bottom === '0px' || cs.bottom === '0')) return false;
          return true;
        }

        function adjustElement(el, bannerZ) {
          try {
            el.style.bottom = OFFSET;
            const currentZ = parseInt(getComputedStyle(el).zIndex) || 0;
            if (currentZ <= bannerZ) {
              el.style.zIndex = (bannerZ + 1).toString();
            }
            el.classList.add(ADJUST_CLASS);
            el.dataset.bannerAdjusted = '1';
          } catch (e) {
            // ignore
          }
        }

        function scanAndAdjust() {
          const bannerZ = getBannerZ();
          const candidates = [];

          // (1) inline-style bottom:0 quick match
          candidates.push(...Array.from(document.querySelectorAll('[style*="bottom: 0px"], [style*="bottom:0"]')));

          // (2) limited scan for computed bottom:0
          const all = Array.from(document.body.getElementsByTagName('*'));
          for (let i = 0, len = Math.min(all.length, SAFETY_MAX); i < len; i++) {
            const el = all[i];
            try {
              const cs = getComputedStyle(el);
              if ((cs.position === 'fixed' || cs.position === 'absolute') && (cs.bottom === '0px' || cs.bottom === '0')) {
                candidates.push(el);
              }
            } catch (e) { /* ignore */ }
          }

          // dedupe
          const set = new Set();
          const uniq = [];
          for (const el of candidates) {
            if (!el || set.has(el)) continue;
            set.add(el);
            uniq.push(el);
          }

          for (const el of uniq) {
            if (shouldAdjust(el)) adjustElement(el, bannerZ);
          }
        }

        // Scroll clamping for the scroll container (#app-root)
        function clampScrollableContainer() {
          const sc = document.getElementById('app-root') || document.scrollingElement || document.documentElement;
          if (!sc) return;

          function clampOnce() {
            try {
              const bannerHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--banner-height')) || 72;
              const scrollHeight = sc.scrollHeight;
              const clientH = sc.clientHeight;
              const maxScrollTop = Math.max(0, scrollHeight - clientH + bannerHeight);
              if (sc.scrollTop > maxScrollTop) {
                sc.scrollTop = maxScrollTop;
              }
            } catch (e) { /* ignore */ }
          }

          // attach on scroll to clamp ongoing
          sc.addEventListener('scroll', clampOnce, { passive: true });
          // run initially
          setTimeout(clampOnce, 50);
          // when layout changes, re-check
          new ResizeObserver(() => clampOnce()).observe(sc);
        }

        // initial run
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            scanAndAdjust();
            clampScrollableContainer();
          }, { once: true });
        } else {
          scanAndAdjust();
          clampScrollableContainer();
        }

        // Observe DOM changes and re-adjust dynamic UI
        const mo = new MutationObserver(() => {
          requestAnimationFrame(() => {
            scanAndAdjust();
            // also re-run clamp since content height may have changed
            try { const sc = document.getElementById('app-root') || document.scrollingElement || document.documentElement; if (sc) { const ev = new Event('resize'); window.dispatchEvent(ev); } } catch (e) {}
          });
        });
        mo.observe(document.documentElement || document.body, { childList: true, subtree: true });

        // debug helpers
        window.__bannerFix = {
          recheck: scanAndAdjust,
          bannerZ: getBannerZ,
          adjustedCount: () => document.querySelectorAll('.' + ADJUST_CLASS).length,
          listAdjusted: () => Array.from(document.querySelectorAll('.' + ADJUST_CLASS)).map(el => ({
            tag: el.tagName, id: el.id, classes: el.className, rect: el.getBoundingClientRect(), z: getComputedStyle(el).zIndex
          }))
        };
      })();
    </script>
  </body>
</html>
